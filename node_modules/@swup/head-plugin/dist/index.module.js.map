{"version":3,"file":"index.module.js","sources":["../src/mergeHeadContents.ts","../src/waitForAssets.ts","../src/index.ts","../src/updateLangAttribute.ts","../src/waitForStylesheet.ts"],"sourcesContent":["type ElementCollection = { el: Element; index?: number }[];\n\nexport default function mergeHeadContents(\n\tcurrentHead: HTMLHeadElement,\n\tnewHead: HTMLHeadElement,\n\t{ shouldPersist = () => false }: { shouldPersist?: (el: Element) => boolean } = {}\n) {\n\tconst currentTags = Array.from(currentHead.children);\n\tconst newChildren = Array.from(newHead.children);\n\n\tconst addTags = getTagsToAdd(currentTags, newChildren);\n\tconst removeTags = getTagsToRemove(currentTags, newChildren);\n\n\t// Remove tags in reverse to keep indexes, keep persistant elements\n\tremoveTags\n\t\t.reverse()\n\t\t.filter(({ el }) => shouldManageTag(el))\n\t\t.filter(({ el }) => !shouldPersist(el))\n\t\t.forEach(({ el }) => currentHead.removeChild(el));\n\n\t// Insert tag *after* previous version of itself to preserve JS variable scope and CSS cascade\n\taddTags\n\t\t.filter(({ el }) => shouldManageTag(el))\n\t\t.forEach(({ el, index = 0 }) => {\n\t\t\tcurrentHead.insertBefore(el, currentHead.children[index + 1] || null);\n\t\t});\n\n\treturn {\n\t\tremoved: removeTags.map(({ el }) => el),\n\t\tadded: addTags.map(({ el }) => el)\n\t};\n}\n\nfunction getTagsToRemove(currentEls: Element[], newEls: Element[]): ElementCollection {\n\treturn currentEls.reduce((tags, el) => {\n\t\tconst isAmongNew = newEls.some((newEl) => compareTags(el, newEl));\n\t\tif (!isAmongNew) {\n\t\t\ttags.push({ el });\n\t\t}\n\t\treturn tags;\n\t}, [] as ElementCollection);\n}\n\nfunction getTagsToAdd(currentEls: Element[], newEls: Element[]): ElementCollection {\n\treturn newEls.reduce((tags, el, index) => {\n\t\tconst isAmongCurrent = currentEls.some((currentEl) => compareTags(el, currentEl));\n\t\tif (!isAmongCurrent) {\n\t\t\ttags.push({ el, index });\n\t\t}\n\t\treturn tags;\n\t}, [] as ElementCollection);\n}\n\nfunction shouldManageTag(el: Element) {\n\t// Let swup manage the title tag\n\tif (el.localName === 'title') {\n\t\treturn false;\n\t}\n\t// Leave swup theme styles untouched\n\tif (el.matches('[data-swup-theme]')) {\n\t\treturn false;\n\t}\n\treturn true;\n}\n\nfunction compareTags(oldTag: Element, newTag: Element) {\n\treturn oldTag.outerHTML === newTag.outerHTML;\n}\n","import waitForStylesheet from './waitForStylesheet.js';\n\nfunction isStylesheet(el: Element): el is HTMLLinkElement {\n\treturn el.matches('link[rel=stylesheet][href]');\n}\n\nexport default function waitForAssets(elements: Element[], timeoutMs: number = 0) {\n\treturn elements.filter(isStylesheet).map((el) => waitForStylesheet(el, timeoutMs));\n}\n","import { Handler } from 'swup';\nimport Plugin from '@swup/plugin';\n\nimport mergeHeadContents from './mergeHeadContents.js';\nimport updateLangAttribute from './updateLangAttribute.js';\nimport waitForAssets from './waitForAssets.js';\n\ntype Options = {\n\t/** Whether to keep orphaned `link`, `style` and `script` tags from the old page. Default: `false` */\n\tpersistAssets: boolean;\n\t/** Tags that will be persisted when a new page is loaded. Boolean, selector or predicate function. Default: `false` */\n\tpersistTags: boolean | string | ((el: Element) => boolean);\n\t/** Delay the transition to the new page until all newly added assets have finished loading. Default: `false` */\n\tawaitAssets: boolean;\n\t/** How long to wait for assets before continuing anyway. Only applies if `awaitAssets` is enabled. Default: `3000` */\n\ttimeout: number;\n};\n\nexport default class SwupHeadPlugin extends Plugin {\n\tname = 'SwupHeadPlugin';\n\n\trequires = { swup: '>=4' };\n\n\tdefaults: Options = {\n\t\tpersistTags: false,\n\t\tpersistAssets: false,\n\t\tawaitAssets: false,\n\t\ttimeout: 3000\n\t};\n\toptions: Options;\n\n\tconstructor(options: Partial<Options> = {}) {\n\t\tsuper();\n\n\t\tthis.options = { ...this.defaults, ...options };\n\n\t\t// persistAssets is a shortcut for: persistTags with a default asset selector for scripts & styles\n\t\tif (this.options.persistAssets && !this.options.persistTags) {\n\t\t\tthis.options.persistTags = 'link[rel=stylesheet], script[src], style';\n\t\t}\n\t}\n\n\tmount() {\n\t\tthis.before('content:replace', this.updateHead);\n\t}\n\n\tupdateHead: Handler<'content:replace'> = async (visit, { page: { html } }) => {\n\t\tconst newDocument = new DOMParser().parseFromString(html, 'text/html');\n\n\t\tconst { removed, added } = mergeHeadContents(document.head, newDocument.head, {\n\t\t\tshouldPersist: (el) => this.isPersistentTag(el)\n\t\t});\n\t\tthis.swup.log(`Removed ${removed.length} / added ${added.length} tags in head`);\n\n\t\tconst lang = updateLangAttribute(document.documentElement, newDocument.documentElement);\n\t\tif (lang) {\n\t\t\tthis.swup.log(`Updated lang attribute: ${lang}`);\n\t\t}\n\n\t\tif (this.options.awaitAssets) {\n\t\t\tconst assetLoadPromises = waitForAssets(added, this.options.timeout);\n\t\t\tif (assetLoadPromises.length) {\n\t\t\t\tthis.swup.log(`Waiting for ${assetLoadPromises.length} assets to load`);\n\t\t\t\tawait Promise.all(assetLoadPromises);\n\t\t\t}\n\t\t}\n\t};\n\n\tisPersistentTag(el: Element) {\n\t\tconst { persistTags } = this.options;\n\t\tif (typeof persistTags === 'function') {\n\t\t\treturn persistTags(el);\n\t\t}\n\t\tif (typeof persistTags === 'string') {\n\t\t\treturn el.matches(persistTags);\n\t\t}\n\t\treturn Boolean(persistTags);\n\t}\n}\n","export default function updateLangAttribute(\n\tcurrentHtml: HTMLElement,\n\tnewHtml: HTMLElement\n): string | null {\n\tif (currentHtml.lang !== newHtml.lang) {\n\t\tcurrentHtml.lang = newHtml.lang;\n\t\treturn currentHtml.lang;\n\t} else {\n\t\treturn null;\n\t}\n}\n","export default function waitForStylesheet(element: HTMLLinkElement, timeoutMs: number = 0) {\n\tconst isLoaded = ({ href }: HTMLLinkElement) => {\n\t\treturn Array.from(document.styleSheets)\n\t\t\t.map(({ href }) => href)\n\t\t\t.includes(href);\n\t};\n\n\tconst whenLoaded = (cb: (value?: unknown) => void) => {\n\t\tif (isLoaded(element)) {\n\t\t\tcb();\n\t\t} else {\n\t\t\tsetTimeout(() => whenLoaded(cb), 10);\n\t\t}\n\t};\n\n\treturn new Promise((resolve) => {\n\t\twhenLoaded(resolve);\n\t\tif (timeoutMs > 0) {\n\t\t\tsetTimeout(resolve, timeoutMs);\n\t\t}\n\t});\n}\n"],"names":["shouldManageTag","el","localName","matches","compareTags","oldTag","newTag","outerHTML","isStylesheet","SwupHeadPlugin","Plugin","constructor","options","super","_this","this","name","requires","swup","defaults","persistTags","persistAssets","awaitAssets","timeout","updateHead","visit","_ref","page","html","newDocument","DOMParser","parseFromString","removed","added","currentHead","newHead","_temp","shouldPersist","currentTags","Array","from","children","newChildren","addTags","currentEls","reduce","tags","index","some","currentEl","push","removeTags","newEls","newEl","getTagsToRemove","reverse","filter","_ref2","forEach","_ref3","removeChild","_ref4","_ref5","insertBefore","map","_ref6","_ref7","mergeHeadContents","document","head","isPersistentTag","log","length","lang","currentHtml","documentElement","newHtml","_temp2","assetLoadPromises","timeoutMs","element","whenLoaded","cb","href","styleSheets","includes","isLoaded","setTimeout","Promise","resolve","waitForStylesheet","all","then","e","reject","mount","before","Boolean"],"mappings":"4BAqDA,SAASA,EAAgBC,GAExB,MAAqB,UAAjBA,EAAGC,YAIHD,EAAGE,QAAQ,oBAIhB,CAEA,SAASC,EAAYC,EAAiBC,GACrC,OAAOD,EAAOE,YAAcD,EAAOC,SACpC,CCjEA,SAASC,EAAaP,GACrB,OAAOA,EAAGE,QAAQ,6BACnB,CCcqB,MAAAM,UAAuBC,EAa3CC,WAAAA,CAAYC,YAAAA,IAAAA,EAA4B,IACvCC,QAAQ,MAAAC,EAkBgBC,KA/BzBC,KAAAA,KAAO,iBAAgBD,KAEvBE,SAAW,CAAEC,KAAM,OAEnBC,KAAAA,SAAoB,CACnBC,aAAa,EACbC,eAAe,EACfC,aAAa,EACbC,QAAS,KACTR,KACDH,aAiBAY,EAAAA,KAAAA,oBAAgDC,EAAKC,GAAE,IAAEC,MAAMC,KAAEA,IAAQF,EAAI,IAC5E,MAAMG,GAAc,IAAIC,WAAYC,gBAAgBH,EAAM,cAEpDI,QAAEA,EAAOC,MAAEA,GF/CL,SACbC,EACAC,EAAwBC,OACxBC,cAAEA,EAAgBA,MAAM,eAAwD,CAAA,EAAED,EAElF,MAAME,EAAcC,MAAMC,KAAKN,EAAYO,UACrCC,EAAcH,MAAMC,KAAKL,EAAQM,UAEjCE,GAiCeC,EAjCQN,EAAaI,EAkC5BG,OAAO,CAACC,EAAM7C,EAAI8C,KACRH,EAAWI,KAAMC,GAAc7C,EAAYH,EAAIgD,KAErEH,EAAKI,KAAK,CAAEjD,KAAI8C,UAEVD,GACL,KAPJ,IAAsBF,EAhCrB,MAAMO,EAsBP,SAAyBP,EAAuBQ,GAC/C,OAAOR,EAAWC,OAAO,CAACC,EAAM7C,KACZmD,EAAOJ,KAAMK,GAAUjD,EAAYH,EAAIoD,KAEzDP,EAAKI,KAAK,CAAEjD,OAEN6C,GACL,GACJ,CA9BoBQ,CAAgBhB,EAAaI,GAgBhD,OAbAS,EACEI,UACAC,OAAO9B,IAAA,IAACzB,GAAEA,GAAIyB,SAAK1B,EAAgBC,EAAE,GACrCuD,OAAOC,IAAC,IAAAxD,GAAEA,GAAIwD,EAAK,OAACpB,EAAcpC,EAAE,GACpCyD,QAAQC,QAAC1D,GAAEA,GAAI0D,EAAA,OAAKzB,EAAY0B,YAAY3D,EAAE,GAGhD0C,EACEa,OAAOK,IAAC,IAAA5D,GAAEA,GAAI4D,EAAK,OAAA7D,EAAgBC,EAAE,GACrCyD,QAAQI,QAAC7D,GAAEA,EAAE8C,MAAEA,EAAQ,GAAGe,EAC1B5B,EAAY6B,aAAa9D,EAAIiC,EAAYO,SAASM,EAAQ,IAAM,KAAI,GAG/D,CACNf,QAASmB,EAAWa,IAAIC,IAAA,IAAChE,GAAEA,GAAIgE,EAAK,OAAAhE,IACpCgC,MAAOU,EAAQqB,IAAIE,IAAC,IAAAjE,GAAEA,GAAIiE,EAAK,OAAAjE,IAEjC,CEkB6BkE,CAAkBC,SAASC,KAAMxC,EAAYwC,KAAM,CAC7EhC,cAAgBpC,GAAOa,EAAKwD,gBAAgBrE,KAE7Ca,EAAKI,KAAKqD,IAAe,WAAAvC,EAAQwC,kBAAkBvC,EAAMuC,uBAEzD,MAAMC,GCrDPC,EDqDkCN,SAASO,iBClD3BF,QAFhBG,EDoD4D/C,EAAY8C,iBClDvCF,MAChCC,EAAYD,KAAOG,EAAQH,KACpBC,EAAYD,WDiDfA,GACH3D,EAAKI,KAAKqD,IAA+B,2BAAAE,KACzC,MAAAI,gBAEG/D,EAAKF,QAAQU,aAChB,MAAMwD,aDtDkDC,ECsDTjE,EAAKF,QAAQW,WDtDJwD,EAAoB,GCsDpC9C,EDrD1BuB,OAAOhD,GAAcwD,IAAK/D,GGPnB,SAAkB+E,EAA0BD,YAAAA,IAAAA,EAAoB,GACvF,MAMME,EAAcC,IANHxD,KAA8B,IAA7ByD,KAAEA,GAAuBzD,EAC1C,OAAOa,MAAMC,KAAK4B,SAASgB,aACzBpB,IAAIP,IAAA,IAAC0B,KAAEA,GAAM1B,EAAA,OAAK0B,IAClBE,SAASF,EAAI,EAIXG,CAASN,GACZE,IAEAK,WAAW,IAAMN,EAAWC,GAAK,GACjC,EAGF,OAAW,IAAAM,QAASC,IACnBR,EAAWQ,GACPV,EAAY,GACfQ,WAAWE,EAASV,EACpB,EAEH,CHdkDW,CAAkBzF,EAAI8E,KCqDA3C,EAAA,WAAA,GACjE0C,EAAkBN,OACmD,OAAxE1D,EAAKI,KAAKqD,IAAmB,eAAAO,EAAkBN,yBAAyBgB,QAAAC,QAClED,QAAQG,IAAIb,IAAkBc,KAAA,WAAA,EAAA,CAHgC,GAGhC,GAAAxD,GAAAA,EAAAwD,KAAA,OAAAxD,EAAAwD,mBDzDhB,IAAmCb,YCyDnBS,QAAAC,QAAAZ,GAAAA,EAAAe,KAAAf,EAAAe,KAGvC,mBAAA,EAAA,CAAC,MAAAC,GAAA,OAAAL,QAAAM,OAAAD,EAAA,KCjEDnB,EACAE,CDgEC,EAhCA7D,KAAKH,QAAU,IAAKG,KAAKI,YAAaP,GAGlCG,KAAKH,QAAQS,gBAAkBN,KAAKH,QAAQQ,cAC/CL,KAAKH,QAAQQ,YAAc,2CAE7B,CAEA2E,KAAAA,GACChF,KAAKiF,OAAO,kBAAmBjF,KAAKS,WACrC,CAwBA8C,eAAAA,CAAgBrE,GACf,MAAMmB,YAAEA,GAAgBL,KAAKH,QAC7B,MAA2B,mBAAhBQ,EACHA,EAAYnB,GAEO,iBAAhBmB,EACHnB,EAAGE,QAAQiB,GAEZ6E,QAAQ7E,EAChB"}